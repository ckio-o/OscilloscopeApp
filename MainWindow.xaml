<Window x:Class="OscilloscopeApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:OscilloscopeApp"
        xmlns:vm="clr-namespace:OscilloscopeApp.ViewModels"
        xmlns:models="clr-namespace:OscilloscopeApp.Models"
        xmlns:dxc="http://schemas.devexpress.com/winfx/2008/xaml/charts"
        xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
        xmlns:dxlc="http://schemas.devexpress.com/winfx/2008/xaml/layoutcontrol"
        mc:Ignorable="d"
        Title="模拟工业示波器" Height="700" Width="1100" Background="#1E1E1E">
    
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <local:WaveTypeToVisibilityConverter x:Key="WaveTypeToVisibilityConverter" />
        <local:NegativeConverter x:Key="NegativeConverter" />
        <local:MultiplyConverter x:Key="MultiplyConverter" />
        <local:DecimalToDoubleConverter x:Key="DecimalToDoubleConverter" />
    </Window.Resources>

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

  
        <Border Grid.Column="0" Background="#2D2D2D" CornerRadius="5" Padding="10" Margin="0,0,10,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock Text="信号源设置" Foreground="White" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>
                    
                    <TextBlock Text="波形类型" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.WaveType, Mode=TwoWay}" 
                                      ItemsSource="{Binding WaveTypeOptions}" 
                                      DisplayMember="Display" ValueMember="Value"
                                      IsTextEditable="False" Margin="0,0,0,10"/>

                    <TextBlock Text="频率 (Hz)" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:SpinEdit EditValue="{Binding Settings.Frequency, Mode=TwoWay, UpdateSourceTrigger=LostFocus, Converter={StaticResource DecimalToDoubleConverter}, ValidatesOnExceptions=False, ValidatesOnDataErrors=False}" 
                                  Margin="0,0,0,10" Increment="1" IsFloatValue="False"/>

                    <TextBlock Text="振幅 (V)" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:SpinEdit EditValue="{Binding Settings.Amplitude, Mode=TwoWay, UpdateSourceTrigger=LostFocus, Converter={StaticResource DecimalToDoubleConverter}, ValidatesOnExceptions=False, ValidatesOnDataErrors=False}" 
                                  Margin="0,0,0,10" Increment="1" IsFloatValue="False"/>

                    <TextBlock Text="占空比 (%)" Foreground="#CCCCCC" Margin="0,5,0,2" 
                               Visibility="{Binding Settings.WaveType, Converter={StaticResource WaveTypeToVisibilityConverter}, ConverterParameter=Square}"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.DutyCycle}" 
                                      ItemsSource="{Binding DutyCycles}" 
                                      IsTextEditable="False" Margin="0,0,0,10"
                                      Visibility="{Binding Settings.WaveType, Converter={StaticResource WaveTypeToVisibilityConverter}, ConverterParameter=Square}"/>

                    <TextBlock Text="噪声强度" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.NoiseLevel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ItemsSource="{Binding NoiseLevels}" 
                                      IsTextEditable="False" Margin="0,0,0,10"/>

                    <Separator Background="#444444" Margin="0,10"/>
                    <TextBlock Text="采样与时间轴" Foreground="White" FontSize="14" FontWeight="Bold" Margin="0,0,0,5"/>

                    <TextBlock Text="采样率" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.SamplingRate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ItemsSource="{Binding SamplingRates}" 
                                      IsTextEditable="False" Margin="0,0,0,10"/>

                    <TextBlock Text="时间基准" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.TimeBase, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ItemsSource="{Binding TimeBases}" 
                                      IsTextEditable="False" Margin="0,0,0,10"/>

                    <Separator Background="#444444" Margin="0,10"/>
                    <TextBlock Text="垂直系统与触发" Foreground="White" FontSize="14" FontWeight="Bold" Margin="0,0,0,5"/>

                    <TextBlock Text="垂直灵敏度" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.VoltDiv, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ItemsSource="{Binding VoltDivs}" 
                                      IsTextEditable="False" Margin="0,0,0,10"/>

                    <TextBlock Text="触发方式" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.TriggerMode, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ItemsSource="{Binding TriggerModeOptions}" 
                                      DisplayMember="Display" ValueMember="Value"
                                      IsTextEditable="False" Margin="0,0,0,10"/>

                    <TextBlock Text="触发边沿" Foreground="#CCCCCC" Margin="0,5,0,2"/>
                    <dxe:ComboBoxEdit EditValue="{Binding Settings.TriggerEdge, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                      ItemsSource="{Binding TriggerEdgeOptions}" 
                                      DisplayMember="Display" ValueMember="Value"
                                      IsTextEditable="False" Margin="0,0,0,10"/>


                    <Separator Background="#444444" Margin="0,10"/>

                    <TextBlock Text="控制" Foreground="White" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Button Content="开始" Command="{Binding StartCommand}" Background="#007ACC" Foreground="White" Height="30" Margin="0,0,5,5"/>
                        <Button Grid.Column="1" Content="停止" Command="{Binding StopCommand}" Background="#D32F2F" Foreground="White" Height="30" Margin="5,0,0,5"/>
                    </Grid>
                    <Button Content="保存当前设置" Command="{Binding SaveCommand}" Background="#45A049" Foreground="White" Height="35" Margin="0,5,0,5"/>
                    <Button Content="保存波形数据" Command="{Binding SaveDataCommand}" Background="#8BC34A" Foreground="White" Height="35" Margin="0,5,0,5"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="120"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="Black" CornerRadius="5">
                <Grid>
                    <dxc:ChartControl DataSource="{Binding WavePoints}" BorderThickness="0">
                        <dxc:ChartControl.Diagram>
                            <dxc:XYDiagram2D>
                                <dxc:XYDiagram2D.AxisX>
                                    <dxc:AxisX2D GridLinesVisible="True" Interlaced="False" GridLinesMinorVisible="True">
                                        <dxc:AxisX2D.Title>
                                            <dxc:AxisTitle Content="时间 (s)" Foreground="#888888" FontSize="10"/>
                                        </dxc:AxisX2D.Title>
                                        <dxc:AxisX2D.Label>
                                            <dxc:AxisLabel Foreground="#888888" FontSize="9"/>
                                        </dxc:AxisX2D.Label>
                                        <dxc:AxisX2D.NumericScaleOptions>
                                            <dxc:ContinuousNumericScaleOptions AutoGrid="False" GridSpacing="{Binding Settings.TimeBase}"/>
                                        </dxc:AxisX2D.NumericScaleOptions>
                                    </dxc:AxisX2D>
                                </dxc:XYDiagram2D.AxisX>
                                <dxc:XYDiagram2D.AxisY>
                                    <dxc:AxisY2D GridLinesVisible="True" GridLinesMinorVisible="True">
                                        <dxc:AxisY2D.Title>
                                            <dxc:AxisTitle Content="电压 (V)" Foreground="#888888" FontSize="10"/>
                                        </dxc:AxisY2D.Title>
                                        <dxc:AxisY2D.Label>
                                            <dxc:AxisLabel Foreground="#888888" FontSize="9"/>
                                        </dxc:AxisY2D.Label>
                                        <dxc:AxisY2D.WholeRange>
                                            <dxc:Range MinValue="{Binding Settings.VoltDiv, Converter={StaticResource MultiplyConverter}, ConverterParameter=-5}" 
                                                       MaxValue="{Binding Settings.VoltDiv, Converter={StaticResource MultiplyConverter}, ConverterParameter=5}" />
                                        </dxc:AxisY2D.WholeRange>
                                        <dxc:AxisY2D.NumericScaleOptions>
                                            <dxc:ContinuousNumericScaleOptions AutoGrid="False" GridSpacing="{Binding Settings.VoltDiv}"/>
                                        </dxc:AxisY2D.NumericScaleOptions>
                                        
                                       
                                        <dxc:AxisY2D.ConstantLinesInFront>
                                            <dxc:ConstantLine Value="0" Brush="Gray">
                                                <dxc:ConstantLine.Title>
                                                    <dxc:ConstantLineTitle Content="0V" Foreground="Gray" Alignment="Far"/>
                                                </dxc:ConstantLine.Title>
                                            </dxc:ConstantLine>
                                            <dxc:ConstantLine Value="{Binding Settings.TriggerLevel}" Brush="Red">
                                            <dxc:ConstantLine.Title>
                                                <dxc:ConstantLineTitle Content="触发" Foreground="Red" Alignment="Near"/>
                                            </dxc:ConstantLine.Title>
                                            </dxc:ConstantLine>
                                        </dxc:AxisY2D.ConstantLinesInFront>
                                    </dxc:AxisY2D>
                                </dxc:XYDiagram2D.AxisY>
                                <dxc:LineSeries2D DisplayName="CH1" 
                                                 ArgumentDataMember="Time" 
                                                 ValueDataMember="Value" 
                                                 MarkerVisible="False"
                                                 Brush="Yellow">
                                    <dxc:LineSeries2D.LineStyle>
                                        <dxc:LineStyle Thickness="2"/>
                                    </dxc:LineSeries2D.LineStyle>
                                </dxc:LineSeries2D>
                            </dxc:XYDiagram2D>
                        </dxc:ChartControl.Diagram>
                        <dxc:ChartControl.CrosshairOptions>
                            <dxc:CrosshairOptions ShowArgumentLine="True" ShowValueLine="True" ShowValueLabels="True" 
                                                 CrosshairLabelMode="ShowForNearestSeries"/>
                        </dxc:ChartControl.CrosshairOptions>
                    </dxc:ChartControl>

                     <StackPanel VerticalAlignment="Top" HorizontalAlignment="Left" Margin="10" Orientation="Horizontal">
                        <Border Background="#44000000" Padding="5" CornerRadius="3" Margin="0,0,5,0">
                            <TextBlock Text="{Binding TriggerStatus}" Foreground="Lime" FontSize="10" FontWeight="Bold"/>
                        </Border>
                        <Border Background="#44000000" Padding="5" CornerRadius="3">
                             <TextBlock Text="CH1: 直流" Foreground="Yellow" FontSize="10" FontWeight="Bold"/>
                        </Border>
                    </StackPanel>

                     <StackPanel VerticalAlignment="Top" HorizontalAlignment="Right" Margin="10" Orientation="Horizontal">
                         <TextBlock Text="{Binding Settings.TimeBase, StringFormat={}时间: {0} 秒/格}" Foreground="White" Margin="0,0,10,0" FontSize="11"/>
                         <TextBlock Text="{Binding Settings.VoltDiv, StringFormat={}电压: {0} 伏/格}" Foreground="White" FontSize="11"/>
                    </StackPanel>
                </Grid>
            </Border>

            <Border Grid.Row="1" Background="#2D2D2D" CornerRadius="5" Margin="0,10,0,0" Padding="10">
                <UniformGrid Columns="4">
                    <StackPanel VerticalAlignment="Center" Margin="5">
                        <TextBlock Text="Vpp (峰峰值)" Foreground="#888888" FontSize="11"/>
                        <TextBlock Text="{Binding Vpp, StringFormat={}{0:F2} V}" Foreground="Yellow" FontSize="20" FontWeight="Bold"/>
                    </StackPanel>

                    <StackPanel VerticalAlignment="Center" Margin="5">
                        <TextBlock Text="Vrms (有效值)" Foreground="#888888" FontSize="11"/>
                        <TextBlock Text="{Binding Vrms, StringFormat={}{0:F2} V}" Foreground="Cyan" FontSize="20" FontWeight="Bold"/>
                    </StackPanel>

                    <StackPanel VerticalAlignment="Center" Margin="5">
                        <TextBlock Text="Frequency (频率)" Foreground="#888888" FontSize="11"/>
                        <TextBlock Text="{Binding AvgFreq, StringFormat={}{0:F1} Hz}" Foreground="Lime" FontSize="20" FontWeight="Bold"/>
                    </StackPanel>

                    <StackPanel VerticalAlignment="Center" Margin="5">
                        <TextBlock Text="Period (周期)" Foreground="#888888" FontSize="11"/>
                        <TextBlock Text="{Binding Period, StringFormat={}{0:F6} s}" Foreground="Orange" FontSize="20" FontWeight="Bold"/>
                    </StackPanel>
                </UniformGrid>
            </Border>
        </Grid>
    </Grid>
</Window>
